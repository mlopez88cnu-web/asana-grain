<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grain → Asana | Create tasks from call transcripts</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --surface2: #243044;
      --border: #2d3a4d;
      --text: #e6edf3;
      --text-muted: #8b9cb3;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #22c55e;
      --error: #ef4444;
      --font: "DM Sans", system-ui, sans-serif;
      --radius: 10px;
      --radius-sm: 6px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 32px 20px 48px;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 8px;
      letter-spacing: -0.02em;
    }
    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 28px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin: 0 0 12px;
    }
    textarea {
      width: 100%;
      min-height: 160px;
      padding: 12px 14px;
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      resize: vertical;
    }
    textarea::placeholder { color: var(--text-muted); opacity: 0.8; }
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--border); }
    .actions-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    select {
      width: 100%;
      max-width: 320px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      margin-bottom: 12px;
    }
    select:focus { outline: none; border-color: var(--accent); }
    .task-list { list-style: none; padding: 0; margin: 0; }
    .task-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }
    .task-item input {
      flex: 1;
      min-width: 0;
      padding: 6px 0;
      font-family: inherit;
      font-size: 0.9rem;
      background: transparent;
      border: none;
      color: var(--text);
    }
    .task-item input::placeholder { color: var(--text-muted); }
    .task-item input:focus { outline: none; }
    .task-item .notes {
      flex: 1;
      min-width: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .task-item .remove {
      flex-shrink: 0;
      padding: 4px 8px;
      font-size: 0.8rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }
    .task-item .remove:hover { color: var(--error); background: rgba(239,68,68,0.1); }
    .empty-tasks {
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 20px;
      text-align: center;
      border: 1px dashed var(--border);
      border-radius: var(--radius-sm);
    }
    .message {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      margin-top: 12px;
    }
    .message.error { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
    .message.success { background: rgba(34,197,94,0.15); color: #86efac; border: 1px solid rgba(34,197,94,0.3); }
    .message a { color: var(--accent); }
  </style>
</head>
<body>
  <div class="app">
    <h1>Grain → Asana</h1>
    <p class="subtitle">Paste a Grain call transcript and turn action items into Asana tasks.</p>

    <div class="card">
      <h2>1. Transcript</h2>
      <textarea id="transcript" placeholder="Paste your Grain transcript here (or export as VTT/SRT and paste). Action items or bullet lists will be detected as tasks."></textarea>
      <div class="actions-row">
        <button type="button" class="btn btn-primary" id="parseBtn">Parse into tasks</button>
      </div>
    </div>

    <div class="card">
      <h2>2. Tasks to create</h2>
      <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0 0 12px;">Review and edit before sending to Asana.</p>
      <ul class="task-list" id="taskList"></ul>
      <div id="emptyTasks" class="empty-tasks" style="display: none;">Parse a transcript above to see tasks here.</div>
    </div>

    <div class="card">
      <h2>3. Send to Asana</h2>
      <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0 0 12px;">Uses your server’s Asana token (set ASANA_ACCESS_TOKEN in Vercel).</p>
      <select id="workspace" aria-label="Workspace">
        <option value="">Select workspace…</option>
      </select>
      <select id="project" aria-label="Project" style="display: none;">
        <option value="">Select project (optional)…</option>
      </select>
      <div class="actions-row">
        <button type="button" class="btn btn-primary" id="createBtn" disabled>Create tasks in Asana</button>
      </div>
      <div id="apiMessage"></div>
    </div>
  </div>

  <script>
    (function () {
      const transcriptEl = document.getElementById('transcript');
      const parseBtn = document.getElementById('parseBtn');
      const taskListEl = document.getElementById('taskList');
      const emptyTasksEl = document.getElementById('emptyTasks');
      const workspaceEl = document.getElementById('workspace');
      const projectEl = document.getElementById('project');
      const createBtn = document.getElementById('createBtn');
      const apiMessageEl = document.getElementById('apiMessage');

      let tasks = [];

      function getApiBase() {
        const a = document.createElement('a');
        a.href = document.querySelector('script[src]')?.src || window.location.href;
        return window.location.origin;
      }

      /**
       * Parse Grain-style transcript into task items.
       * - Looks for "Action items", "Next steps", "Follow-up" sections
       * - Otherwise splits by bullet lines (- , *, •) or numbered lines (1. 2. 3.)
       * - Strips VTT/SRT timestamp lines when present
       */
      function parseTranscript(text) {
        if (!text || !text.trim()) return [];
        let s = text.trim();

        // Strip VTT/SRT timestamp lines (e.g. "00:00:01.000 --> 00:00:05.000" or "1\n00:00:00,000 --> 00:00:02,000")
        s = s.replace(/^\d+\s*\n/gm, '');
        s = s.replace(/\d{1,2}:\d{2}(:\d{2})?([.,]\d{2,3})?\s*-->\s*\d{1,2}:\d{2}(:\d{2})?([.,]\d{2,3})?/gm, '');

        const out = [];
        const sectionRegex = /(?:action\s*items?|next\s*steps?|follow[- ]?ups?|to[- ]?do|tasks?)\s*:?\s*\n([\s\S]*?)(?=\n\n[A-Z]|\n#{1,3}\s|\n(?:action\s*items?|next\s*steps?|follow[- ]?ups?|to[- ]?do|tasks?)\s*:|\z)/gim;
        let match;
        while ((match = sectionRegex.exec(s)) !== null) {
          const block = match[1].trim();
          const lines = block.split(/\n/).map(l => l.trim()).filter(Boolean);
          for (const line of lines) {
            const name = stripBullet(line);
            if (name.length >= 2) out.push({ name, notes: '' });
          }
        }

        if (out.length > 0) return out;

        // No section found: treat bullets or numbered lines as tasks
        const lines = s.split(/\n/).map(l => l.trim()).filter(Boolean);
        for (const line of lines) {
          if (!/^[\d]+[.)]\s+/.test(line) && !/^[-*•]\s+/.test(line)) continue;
          const name = stripBullet(line);
          if (name.length >= 2) out.push({ name, notes: '' });
        }

        if (out.length > 0) return out;

        // Fallback: each non-empty line as a task (skip obvious timestamps/speaker labels)
        const fallback = [];
        for (const line of lines) {
          if (line.length < 3) continue;
          if (/^\[?\d{1,2}:\d{2}/.test(line) || /^[A-Z][a-z]+:\s*$/.test(line)) continue;
          fallback.push({ name: line.replace(/^[-*•]\s*/, ''), notes: '' });
        }
        return fallback;
      }

      function stripBullet(line) {
        return line
          .replace(/^[\d]+[.)]\s+/, '')
          .replace(/^[-*•]\s+/, '')
          .trim();
      }

      function renderTasks() {
        taskListEl.innerHTML = '';
        if (tasks.length === 0) {
          emptyTasksEl.style.display = 'block';
          createBtn.disabled = true;
          return;
        }
        emptyTasksEl.style.display = 'none';
        createBtn.disabled = !workspaceEl.value;
        tasks.forEach((t, i) => {
          const li = document.createElement('li');
          li.className = 'task-item';
          li.innerHTML = `
            <div style="flex: 1; min-width: 0;">
              <input type="text" data-i="${i}" data-field="name" value="${escapeHtml(t.name)}" placeholder="Task name" />
              ${t.notes ? `<div class="notes" data-i="${i}">${escapeHtml(t.notes)}</div>` : ''}
            </div>
            <button type="button" class="remove" data-i="${i}" aria-label="Remove">Remove</button>
          `;
          taskListEl.appendChild(li);
        });
        taskListEl.querySelectorAll('input[data-field="name"]').forEach(inp => {
          inp.addEventListener('input', () => { tasks[+inp.dataset.i].name = inp.value; });
        });
        taskListEl.querySelectorAll('.remove').forEach(btn => {
          btn.addEventListener('click', () => {
            tasks.splice(+btn.dataset.i, 1);
            renderTasks();
          });
        });
      }

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      parseBtn.addEventListener('click', () => {
        const text = transcriptEl.value;
        tasks = parseTranscript(text);
        renderTasks();
      });

      function loadWorkspaces() {
        fetch(getApiBase() + '/api/asana/workspaces')
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              workspaceEl.innerHTML = '<option value="">' + escapeHtml(data.error) + '</option>';
              return;
            }
            workspaceEl.innerHTML = '<option value="">Select workspace…</option>';
            (data || []).forEach(w => {
              const opt = document.createElement('option');
              opt.value = w.gid;
              opt.textContent = w.name || w.gid;
              workspaceEl.appendChild(opt);
            });
          })
          .catch(() => {
            workspaceEl.innerHTML = '<option value="">Failed to load (check API / CORS)</option>';
          });
      }

      workspaceEl.addEventListener('change', () => {
        const gid = workspaceEl.value;
        projectEl.style.display = gid ? 'block' : 'none';
        projectEl.innerHTML = '<option value="">Select project (optional)…</option>';
        createBtn.disabled = !gid || tasks.length === 0;
        if (!gid) return;
        fetch(getApiBase() + '/api/asana/projects?workspace=' + encodeURIComponent(gid))
          .then(r => r.json())
          .then(data => {
            if (data.error) return;
            (data || []).forEach(p => {
              const opt = document.createElement('option');
              opt.value = p.gid;
              opt.textContent = p.name || p.gid;
              projectEl.appendChild(opt);
            });
          });
      });

      createBtn.addEventListener('click', () => {
        const workspaceGid = workspaceEl.value;
        const projectGid = projectEl.value || undefined;
        const payload = {
          workspaceGid,
          projectGid: projectGid || undefined,
          tasks: tasks.map(t => ({ name: t.name.trim(), notes: (t.notes || '').trim() })).filter(t => t.name),
        };
        if (!payload.tasks.length) {
          apiMessageEl.innerHTML = '<div class="message error">No tasks to create (add at least one non-empty name).</div>';
          return;
        }
        createBtn.disabled = true;
        apiMessageEl.innerHTML = '';
        fetch(getApiBase() + '/api/asana/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then(r => r.json())
          .then(data => {
            createBtn.disabled = false;
            if (data.created && data.created.length) {
              const links = data.created.map(c => c.permalink_url ? `<a href="${escapeHtml(c.permalink_url)}" target="_blank" rel="noopener">${escapeHtml(c.name)}</a>` : escapeHtml(c.name)).join(', ');
              apiMessageEl.innerHTML = '<div class="message success">Created ' + data.created.length + ' task(s): ' + links + '</div>';
            }
            if (data.errors && data.errors.length) {
              const errMsg = data.errors.map(e => escapeHtml(e.message || e.task?.name)).join('; ');
              apiMessageEl.innerHTML = (apiMessageEl.innerHTML || '') + '<div class="message error">Errors: ' + errMsg + '</div>';
            }
            if (!(data.created && data.created.length) && (!data.errors || !data.errors.length)) {
              apiMessageEl.innerHTML = '<div class="message error">Unexpected response. Check server logs.</div>';
            }
          })
          .catch(e => {
            createBtn.disabled = false;
            apiMessageEl.innerHTML = '<div class="message error">Request failed: ' + escapeHtml(e.message) + '</div>';
          });
      });

      loadWorkspaces();
    })();
  </script>
</body>
</html>
